<body class="text-gray-800 flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold brand-dark-green">
                GreenDrop
            </a>
            
            <div class="hidden md:flex items-center space-x-4">
                <form action="/logout" method="GET" class="inline">
                    <button type="submit" class="py-2 px-4 rounded-lg font-medium text-white bg-red-600 hover:bg-red-700 transition-all duration-300 transform hover:scale-105">
                        Sair
                    </button>
                </form>
            </div>

            <button class="md:hidden focus:outline-none" id="mobile-menu-button">
                <i data-feather="menu" class="h-6 w-6 text-gray-600"></i>
            </button>
        </nav>

        <div class="md:hidden bg-white shadow-md absolute top-full left-0 w-full z-50 hidden" id="mobile-menu">
            <div class="px-6 py-4">
                <a href="/" class="block py-2 px-4 rounded-lg font-medium text-white bg-brand-green hover:bg-brand-green-dark transition-all duration-300 transform hover:scale-105">
                    Sair
                </a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold brand-dark-green mb-2">Encontre Nossos Pontos de Coleta</h1>
            <p class="text-lg text-gray-600">Localize o ponto GreenDrop mais próximo de você.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-1/3 xl:w-1/4 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold brand-dark-green mb-4">Pontos Próximos</h2>
                <div class="mb-4">
                    <input type="text" placeholder="Buscar por endereço ou CEP..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div id="locations-list" class="space-y-2 overflow-y-auto" style="max-height: calc(100vh - 380px);">
                </div>
            </aside>
            
            <section class="w-full lg:w-2/3 xl:w-3/4">
                <div id="map" class="shadow-lg rounded-2xl h-[600px] w-full"></div>
            </section>
        </div>
    </main>

    <!-- Modal de Avaliações -->
    <div id="reviews-modal" class="reviews-modal hidden">
        <div class="reviews-modal-overlay" onclick="closeReviewsModal()"></div>
        <div class="reviews-modal-content">
            <div class="reviews-modal-header">
                <h2 id="modal-point-name" class="text-xl font-bold">Avaliações</h2>
                <button onclick="closeReviewsModal()" class="close-btn">&times;</button>
            </div>
            <div class="reviews-modal-body">
                <div id="modal-rating-section" class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-sm text-gray-600">Avaliar:</span>
                        <div id="modal-rating-stars" class="rating-stars interactive">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                    </div>
                    <textarea id="modal-review-comment" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="Deixe um comentário (opcional)"></textarea>
                    <button id="modal-submit-review" class="mt-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-semibold">Enviar Avaliação</button>
                </div>
                <div id="modal-reviews-list" class="reviews-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        feather.replace();

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Carregar pontos de coleta da API
        let locations = [];

        // Função para renderizar estrelas
        function renderStars(rating, interactive = false) {
            const stars = [];
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            for (let i = 1; i <= 5; i++) {
                let starClass = '';
                if (i <= fullStars) {
                    starClass = 'active';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    starClass = 'active';
                }
                stars.push(`<span class="star ${starClass}" ${interactive ? `data-rating="${i}"` : ''} style="color: ${starClass ? '#fbbf24' : '#d1d5db'}; font-size: 16px; cursor: ${interactive ? 'pointer' : 'default'};">★</span>`);
            }
            return `<div style="display: inline-flex; gap: 2px;">${stars.join('')}</div>`;
        }

        async function carregarPontos() {
            try {
                const response = await fetch('/api/pontos');
                const pontos = await response.json();
                
                locations = pontos.map(ponto => ({
                    id: ponto.id,
                    name: ponto.name || ponto.nome,
                    address: ponto.address || ponto.endereco,
                    lat: parseFloat(ponto.lat || ponto.latitude),
                    lng: parseFloat(ponto.lng || ponto.longitude),
                    residuos: (ponto.materials && Array.isArray(ponto.materials) ? ponto.materials : 
                              (ponto.residuos && Array.isArray(ponto.residuos) ? ponto.residuos.map(r => r.nome || r) : 
                              ['Não especificado'])).join(', '),
                    telefone: ponto.telefone,
                    horario: ponto.horario || ponto.horarioFuncionamento,
                    rating: ponto.rating || 0,
                    totalReviews: ponto.totalReviews || 0,
                }));

                inicializarMapa();
            } catch (error) {
                console.error('Erro ao carregar pontos:', error);
                // Usar dados mock se a API falhar
                locations = [
                    {
                        id: 1,
                        name: "Ponto de Coleta - Parque Ibirapuera",
                        address: "Av. Pedro Álvares Cabral, s/n - Vila Mariana",
                        lat: -23.588,
                        lng: -46.656,
                        residuos: "Plástico, Papel, Vidro",
                        rating: 0,
                        totalReviews: 0
                    },
                ];
                inicializarMapa();
            }
        }

        function inicializarMapa() {
            // Centralizar no primeiro ponto ou em São Paulo
            const centerLat = locations.length > 0 ? locations[0].lat : -23.56;
            const centerLng = locations.length > 0 ? locations[0].lng : -46.66;
            
            const map = L.map('map').setView([centerLat, centerLng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const greenIcon = L.divIcon({
                className: 'custom-marker-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });

            const locationsList = document.getElementById('locations-list');
            const markers = {};

            locations.forEach(location => {
                const rating = location.rating || 0;
                const totalReviews = location.totalReviews || 0;
                const starsHtml = renderStars(rating, false);
                const ratingSection = `<div style="margin: 8px 0; cursor: pointer;" onclick="event.stopPropagation(); openReviewsModal(${location.id}, '${(location.name || '').replace(/'/g, "\\'")}')">${starsHtml} <small style="color:#6B7280;">(${totalReviews} avaliação${totalReviews !== 1 ? 'ões' : ''})</small></div>`;
                
                const marker = L.marker([location.lat, location.lng], { icon: greenIcon }).addTo(map)
                    .bindPopup(`
                        <div class="font-sans">
                            <h3 class="font-bold text-lg brand-dark-green">${location.name}</h3>
                            <p class="text-gray-600 text-sm mb-2">${location.address}</p>
                            <p class="text-sm text-gray-500"><strong>Aceita:</strong> ${location.residuos}</p>
                            ${location.horario ? `<p class="text-sm text-gray-500"><strong>Horário:</strong> ${location.horario}</p>` : ''}
                            ${ratingSection}
                            <a href="/pontos/${location.id}" class="text-green-600 hover:underline text-sm font-medium mt-2 inline-block">Ver detalhes →</a>
                        </div>
                    `);
                
                markers[location.id] = marker;

                const rating = location.rating || 0;
                const totalReviews = location.totalReviews || 0;
                const starsHtml = renderStars(rating, false);
                
                const locationItem = document.createElement('div');
                locationItem.className = 'p-4 rounded-lg cursor-pointer hover:bg-green-50 transition-colors border-b border-gray-100';
                locationItem.innerHTML = `
                    <h3 class="font-semibold brand-dark-green mb-1">${location.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${location.address}</p>
                    ${location.horario ? `<p class="text-xs text-gray-500 mb-2"><strong>Horário:</strong> ${location.horario}</p>` : ''}
                    <div class="mt-2 mb-2 flex items-center gap-2 cursor-pointer rating-clickable" data-point-id="${location.id}" data-point-name="${(location.name || '').replace(/"/g, '&quot;')}">
                        ${starsHtml}
                        <span class="text-xs ${totalReviews > 0 ? 'text-gray-500' : 'text-gray-400'}">${totalReviews > 0 ? `(${totalReviews})` : 'Sem avaliações'}</span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${location.residuos.split(', ').slice(0, 3).map(r => `
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800">${r}</span>
                        `).join('')}
                        ${location.residuos.split(', ').length > 3 ? '<span class="text-xs text-gray-500">...</span>' : ''}
                    </div>
                `;
                
                // Adicionar evento de clique nas estrelas
                const ratingDiv = locationItem.querySelector('.rating-clickable');
                if (ratingDiv) {
                    ratingDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const pointId = parseInt(ratingDiv.dataset.pointId);
                        const pointName = ratingDiv.dataset.pointName || location.name || 'Ponto de Coleta';
                        openReviewsModal(pointId, pointName);
                    });
                }
                
                locationItem.addEventListener('click', () => {
                    map.flyTo([location.lat, location.lng], 15);
                    marker.openPopup();
                });

                locationsList.appendChild(locationItem);
            });

            // Ajustar bounds se houver pontos
            if (locations.length > 0) {
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Carregar pontos ao carregar a página
        carregarPontos();

        // ------ Modal de Avaliações ------
        let currentPontoId = null;
        let currentRating = 0;

        window.openReviewsModal = async function(pontoId, pointName) {
            currentPontoId = pontoId;
            document.getElementById('modal-point-name').textContent = `${pointName} - Avaliações`;
            document.getElementById('reviews-modal').classList.remove('hidden');
            
            // Resetar estrelas
            const stars = document.querySelectorAll('#modal-rating-stars .star');
            stars.forEach(s => {
                s.classList.remove('active');
                s.style.color = '#d1d5db';
            });
            currentRating = 0;
            
            // Carregar avaliações
            await loadReviews(pontoId);
            
            // Bind eventos das estrelas
            bindModalStarEvents();
            bindSubmitReview();
        };

        window.closeReviewsModal = function() {
            document.getElementById('reviews-modal').classList.add('hidden');
            currentPontoId = null;
            currentRating = 0;
        };

        function bindModalStarEvents() {
            const stars = document.querySelectorAll('#modal-rating-stars .star');
            stars.forEach((star, index) => {
                star.onclick = () => {
                    const rating = index + 1;
                    currentRating = rating;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.add('active');
                            s.style.color = '#fbbf24';
                        } else {
                            s.classList.remove('active');
                            s.style.color = '#d1d5db';
                        }
                    });
                };
            });
        }

        function bindSubmitReview() {
            const submitBtn = document.getElementById('modal-submit-review');
            if (submitBtn.onclick) return; // Já bindado
            
            submitBtn.onclick = async () => {
                if (!currentRating) {
                    alert('Por favor, selecione uma nota');
                    return;
                }
                
                try {
                    const comentario = document.getElementById('modal-review-comment').value;
                    const response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            pontoColetaId: currentPontoId,
                            nota: currentRating,
                            comentario: comentario || null
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Você precisa estar logado para avaliar');
                            return;
                        }
                        throw new Error('Erro ao enviar avaliação');
                    }
                    
                    // Recarregar avaliações e atualizar lista de pontos
                    await loadReviews(currentPontoId);
                    document.getElementById('modal-review-comment').value = '';
                    currentRating = 0;
                    const stars = document.querySelectorAll('#modal-rating-stars .star');
                    stars.forEach(s => {
                        s.classList.remove('active');
                        s.style.color = '#d1d5db';
                    });
                    
                    // Recarregar pontos para atualizar médias
                    await carregarPontos();
                } catch (error) {
                    console.error('Erro ao enviar avaliação:', error);
                    alert('Erro ao enviar avaliação. Tente novamente.');
                }
            };
        }

        async function loadReviews(pontoId) {
            try {
                const response = await fetch(`/api/reviews/ponto/${pontoId}`);
                const reviews = await response.json();
                
                const reviewsList = document.getElementById('modal-reviews-list');
                if (!reviews || reviews.length === 0) {
                    reviewsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Ainda não há avaliações para este ponto.</p>';
                    return;
                }
                
                reviewsList.innerHTML = reviews.map(review => {
                    const user = review.user || {};
                    const userName = user.name || 'Usuário Anônimo';
                    const userInitial = userName.charAt(0).toUpperCase();
                    const date = new Date(review.createdAt);
                    const timeAgo = getTimeAgo(date);
                    const starsHtml = renderStars(review.nota, false);
                    
                    return `
                        <div class="review-item">
                            <div class="review-header">
                                <div class="review-avatar">${userInitial}</div>
                                <div class="review-info">
                                    <div class="review-author">${userName}</div>
                                    <div class="review-date">${timeAgo}</div>
                                </div>
                            </div>
                            <div class="review-rating">${starsHtml}</div>
                            ${review.comentario ? `<div class="review-comment">${review.comentario}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar avaliações:', error);
                document.getElementById('modal-reviews-list').innerHTML = '<p class="text-sm text-red-500 text-center py-4">Erro ao carregar avaliações.</p>';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);
            
            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return `${diffMins} minuto${diffMins > 1 ? 's' : ''} atrás`;
            if (diffHours < 24) return `${diffHours} hora${diffHours > 1 ? 's' : ''} atrás`;
            if (diffDays < 30) return `${diffDays} dia${diffDays > 1 ? 's' : ''} atrás`;
            if (diffMonths < 12) return `${diffMonths} mês${diffMonths > 1 ? 'es' : ''} atrás`;
            return `${diffYears} ano${diffYears > 1 ? 's' : ''} atrás`;
        }

    </script>
    
    <style>
        .rating-stars{
            display:inline-flex; gap:2px; font-size:18px; color:#d1d5db; cursor:pointer;
        }
        .rating-stars .star{
            transition:color .15s ease; user-select:none;
        }
        .rating-stars .star.active{ color:#fbbf24; }
        .rating-stars.interactive .star:hover{ color:#fbbf24; }

        .reviews-modal{
            position:fixed; inset:0; z-index:2000; display:flex; align-items:center; justify-content:center;
        }
        .reviews-modal.hidden{ display:none; }
        .reviews-modal-overlay{
            position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(2px);
        }
        .reviews-modal-content{
            position:relative; background:#fff; border-radius:16px; max-width:600px; width:90%;
            max-height:90vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 40px rgba(0,0,0,.2);
        }
        .reviews-modal-header{
            padding:20px; border-bottom:1px solid #E5E7EB; display:flex; justify-content:space-between; align-items:center;
        }
        .reviews-modal-body{
            padding:20px; overflow-y:auto; flex:1;
        }
        .close-btn{
            width:32px; height:32px; border:0; background:transparent; font-size:24px; cursor:pointer;
            color:#6B7280; display:flex; align-items:center; justify-content:center; border-radius:50%;
            transition:background .2s ease;
        }
        .close-btn:hover{ background:#f3f4f6; color:#111827; }

        .reviews-list{ display:flex; flex-direction:column; gap:16px; }
        .review-item{
            padding:16px; background:#f9fafb; border-radius:10px; border:1px solid #E5E7EB;
        }
        .review-header{
            display:flex; align-items:center; gap:12px; margin-bottom:8px;
        }
        .review-avatar{
            width:40px; height:40px; border-radius:50%; background:#34A853; color:#fff;
            display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px;
        }
        .review-info{ flex:1; }
        .review-author{ font-weight:600; color:#111827; font-size:14px; }
        .review-date{ font-size:12px; color:#6B7280; }
        .review-rating{ margin:8px 0; }
        .review-comment{ font-size:14px; color:#374151; line-height:1.5; }
    </style>
</body>
